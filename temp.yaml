AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: >
  heua-api: Backend Manajemen Keuangan HeUa

Globals:
  Function:
    Timeout: 10 # Ditingkatkan sedikit agar Hapi.js punya waktu inisialisasi
    MemorySize: 128
    Runtime: nodejs22.x
    Tracing: Active
    Architectures:
      - arm64 # Lebih murah dan masuk jatah Always Free
    LoggingConfig:
      LogFormat: JSON

Resources:
  # 1. Lambda Function Utama
  HeuaFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/   
      Handler: app.lambdaHandler
      Events:
        HeuaApi:
          Type: Api
          Properties:
            Path: /{proxy+} 
            Method: ANY
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref HeuaTable 
    Metadata: # Indentasi diperbaiki, sejajar dengan Properties
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2020
        Sourcemap: true
        EntryPoints:
          - app.ts

  # 2. Database DynamoDB (Always Free)
  HeuaTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: HeuaData
      BillingMode: PAY_PER_REQUEST # Gratis hingga 25 GB penyimpanan
      AttributeDefinitions:
        - AttributeName: PK
          AttributeType: S
        - AttributeName: SK
          AttributeType: S
      KeySchema:
        - AttributeName: PK
          KeyType: HASH
        - AttributeName: SK
          KeyType: RANGE

Outputs:
  HeuaApiUrl:
    Description: "URL API Gateway untuk aplikasi Kotlin Anda"
    Value: !Sub "https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/"
  HeuaFunctionArn:
    Description: "ARN Fungsi Lambda Heua"
    Value: !GetAtt HeuaFunction.Arn